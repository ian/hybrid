name: Test Hybrid CLI

on:
  push:
    branches: [main, develop]
    paths:
      - 'packages/cli/**'
      - '.github/workflows/test-cli.yml'
  pull_request:
    branches: [main, develop]
    paths:
      - 'packages/cli/**'
      - '.github/workflows/test-cli.yml'

jobs:
  test-cli:
    name: Test Hybrid CLI Project Generator
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v4
        with:
          run_install: false
      - uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build all packages
        run: pnpm build

      - name: Verify CLI binary exists
        run: |
          echo "ðŸ” Checking CLI binary..."
          if [ ! -f "packages/cli/dist/cli.js" ]; then
            echo "âŒ CLI binary not found at packages/cli/dist/cli.js"
            ls -la packages/cli/dist/
            exit 1
          fi
          echo "âœ… CLI binary exists"
          ls -la packages/cli/dist/cli.js

          echo "ðŸ” Testing CLI help command..."
          if ! node packages/cli/dist/cli.js --help; then
            echo "âŒ CLI help command failed"
            exit 1
          fi
          echo "âœ… CLI help command successful"

      - name: Create test directory
        run: |
          mkdir -p test-project
          cd test-project

      - name: Test CLI help (no args)
        run: |
          echo "ðŸ” Testing CLI without arguments..."
          if ! node "$GITHUB_WORKSPACE/packages/cli/dist/cli.js"; then
            echo "âŒ CLI should show help when no arguments provided"
            exit 1
          fi
          echo "âœ… CLI help displayed successfully"
        working-directory: test-project

      - name: Test project creation with specific name
        run: |
          echo "ðŸ” Testing project creation with name 'test-agent-cli'..."
          if ! node "$GITHUB_WORKSPACE/packages/cli/dist/cli.js" init test-agent-cli; then
            echo "âŒ Project creation failed"
            exit 1
          fi
          echo "âœ… Project created successfully"
        working-directory: test-project

      - name: Verify project structure
        run: |
          echo "ðŸ” Verifying project structure for 'test-agent-cli'..."

          echo "ðŸ“‚ Checking project root directory..."
          if [ ! -d "test-agent-cli" ]; then
            echo "âŒ Project directory 'test-agent-cli' not found"
            ls -la
            exit 1
          fi
          echo "âœ… Project directory exists"
          ls -la test-agent-cli/
        working-directory: test-project

          echo "ðŸ“‚ Checking src directory..."
          if [ ! -d "test-agent-cli/src" ]; then
            echo "âŒ src directory not found"
            ls -la test-agent-cli/
            exit 1
          fi
          echo "âœ… src directory exists"
          ls -la test-agent-cli/src/

          echo "ðŸ“„ Checking required files..."

          required_files=(
            "package.json"
            "README.md"
            ".env"
            "tsconfig.json"
            "vitest.config.ts"
            "src/agent.ts"
            "src/agent.test.ts"
          )

          missing_files=()

          for file in "${required_files[@]}"; do
            if [ ! -f "test-agent-cli/$file" ]; then
              missing_files+=("$file")
              echo "âŒ Missing: $file"
            else
              echo "âœ… Found: $file"
            fi
          done

          if [ ${#missing_files[@]} -gt 0 ]; then
            echo "âŒ Missing files: ${missing_files[*]}"
            exit 1
          fi

          echo "âœ… All required files are present"
        working-directory: test-project

      - name: Verify package.json content
        run: |
          echo "ðŸ” Verifying package.json content..."
          cd test-agent-cli

          echo "ðŸ“‹ Checking package.json exists and is valid JSON..."
          if ! cat package.json; then
            echo "âŒ Cannot read package.json"
            exit 1
          fi

          if ! node -e "JSON.parse(require('fs').readFileSync('package.json', 'utf8'))"; then
            echo "âŒ package.json is not valid JSON"
            exit 1
          fi
          echo "âœ… package.json is valid JSON"

          echo "ðŸ” Checking specific fields..."

          # Check name field
          if ! grep -q '"name": "test-agent-cli"' package.json; then
            echo "âŒ Expected name field not found"
            echo "Current name field:"
            node -e "console.log(JSON.parse(require('fs').readFileSync('package.json', 'utf8')).name)"
            exit 1
          fi
          echo "âœ… Name field is correct: test-agent-cli"

          # Check version field
          if ! grep -q '"version": "0.1.0"' package.json; then
            echo "âŒ Expected version field not found"
            echo "Current version field:"
            node -e "console.log(JSON.parse(require('fs').readFileSync('package.json', 'utf8')).version)"
            exit 1
          fi
          echo "âœ… Version field is correct: 0.1.0"

          # Check dev script (from template: "hybrid dev")
          if ! grep -q '"dev": "hybrid dev"' package.json; then
            echo "âŒ Expected dev script not found"
            echo "Current scripts:"
            node -e "console.log(JSON.stringify(JSON.parse(require('fs').readFileSync('package.json', 'utf8')).scripts, null, 2))"
            exit 1
          fi
          echo "âœ… Dev script is correct"

          # Check keys script
          if ! grep -q '"keys": "hybrid gen:keys"' package.json; then
            echo "âŒ Expected keys script not found"
            echo "Current scripts:"
            node -e "console.log(JSON.stringify(JSON.parse(require('fs').readFileSync('package.json', 'utf8')).scripts, null, 2))"
            exit 1
          fi
          echo "âœ… Keys script is correct"
        working-directory: test-project

      - name: Verify README has correct project name
        run: |
          echo "ðŸ” Verifying README.md content..."
          cd test-agent-cli

          if [ ! -f "README.md" ]; then
            echo "âŒ README.md file not found"
            ls -la
            exit 1
          fi

          echo "ðŸ“„ README.md content:"
          cat README.md

          if ! grep -q '^# test-agent-cli$' README.md; then
            echo "âŒ Expected header '# test-agent-cli' not found in README.md"
            echo "Current header line:"
            head -1 README.md
            exit 1
          fi
          echo "âœ… README.md has correct project name"
        working-directory: test-project

      - name: Test key generation
        run: |
          echo "ðŸ” Testing key generation..."
          cd test-agent-cli

          echo "ðŸ”‘ Running key generation command..."
          if ! node "$GITHUB_WORKSPACE/packages/cli/dist/cli.js" gen:keys --write; then
            echo "âŒ Key generation command failed"
            exit 1
          fi
          echo "âœ… Key generation command completed"

          echo "ðŸ“„ Checking .env file..."
          if [ ! -f ".env" ]; then
            echo "âŒ .env file not found"
            ls -la
            exit 1
          fi

          echo "ðŸ” .env file contents (without sensitive data):"
          grep -v "your_wallet_key_here\|your_encryption_key_here\|XMTP_WALLET_KEY=\|XMTP_ENCRYPTION_KEY=" .env || echo "No non-sensitive content found"
          echo "ðŸ” Sensitive environment variables (masked):"
          grep "XMTP_WALLET_KEY=" .env | sed 's/=0x.*/=0x[MASKED]/' || echo "XMTP_WALLET_KEY not found"
          grep "XMTP_ENCRYPTION_KEY=" .env | sed 's/=.*$/=[MASKED]/' || echo "XMTP_ENCRYPTION_KEY not found"

          echo "ðŸ” Validating environment variables..."

          # Check for wallet key
          if ! grep -q "XMTP_WALLET_KEY=0x" .env; then
            echo "âŒ XMTP_WALLET_KEY not found or not in correct format"
            echo "Expected format: XMTP_WALLET_KEY=0x..."
            exit 1
          fi
          echo "âœ… XMTP_WALLET_KEY is present and correctly formatted"

          # Check for encryption key
          if ! grep -q "XMTP_ENCRYPTION_KEY=" .env; then
            echo "âŒ XMTP_ENCRYPTION_KEY not found"
            echo "Expected format: XMTP_ENCRYPTION_KEY=..."
            exit 1
          fi
          echo "âœ… XMTP_ENCRYPTION_KEY is present"
        working-directory: test-project

      - name: Test interactive project creation
        run: |
          echo "ðŸ” Testing interactive project creation..."
          echo "ðŸ“ Providing empty input to trigger interactive mode..."
          if ! echo -e "\n" | node "$GITHUB_WORKSPACE/packages/cli/dist/cli.js" init; then
            echo "âŒ Interactive project creation failed"
            exit 1
          fi
          echo "âœ… Interactive project creation command completed"
        working-directory: test-project

      - name: Verify interactive project creation
        run: |
          echo "ðŸ” Verifying interactive project creation result..."

          if [ ! -d "my-hybrid-agent" ]; then
            echo "âŒ Expected project directory 'my-hybrid-agent' not found"
            echo "Available directories:"
            ls -la | grep "^d"
            exit 1
          fi
          echo "âœ… Project directory 'my-hybrid-agent' created"
          ls -la my-hybrid-agent/

          if [ ! -f "my-hybrid-agent/package.json" ]; then
            echo "âŒ package.json not found in my-hybrid-agent/"
            ls -la my-hybrid-agent/
            exit 1
          fi
          echo "âœ… package.json exists"

          echo "ðŸ” Checking package.json name field..."
          if ! grep -q '"name": "my-hybrid-agent"' my-hybrid-agent/package.json; then
            echo "âŒ Expected name 'my-hybrid-agent' not found in package.json"
            echo "Current name:"
            node -e "console.log(JSON.parse(require('fs').readFileSync('my-hybrid-agent/package.json', 'utf8')).name)"
            exit 1
          fi
          echo "âœ… Package.json has correct name: my-hybrid-agent"
        working-directory: test-project

      - name: Test build command (should fail without deps, but verify it runs)
        run: |
          echo "ðŸ” Testing build command without dependencies..."
          cd test-agent-cli

          echo "ðŸ—ï¸ Running build command..."
          if node "$GITHUB_WORKSPACE/packages/cli/dist/cli.js" build; then
            echo "âš ï¸ Build succeeded unexpectedly (might have dependencies installed)"
          else
            echo "âœ… Build failed as expected without dependencies"
          fi

          echo "ðŸ“‚ Checking if build artifacts were created..."
          if [ -d "dist" ]; then
            echo "âœ… Build directory created despite failure"
            ls -la dist/
          else
            echo "â„¹ï¸ No build directory created (expected)"
          fi
        working-directory: test-project

      - name: Test dev command (should start but we'll kill it)
        run: |
          echo "ðŸ” Testing dev command..."
          cd test-agent-cli

          echo "ðŸš€ Starting dev server (will timeout after 5 seconds)..."
          if timeout 5 node "$GITHUB_WORKSPACE/packages/cli/dist/cli.js" dev 2>&1; then
            echo "âœ… Dev server started successfully and was killed after 5 seconds"
          else
            echo "âš ï¸ Dev server may have failed to start or was killed"
          fi
        working-directory: test-project

      - name: Clean up test projects
        run: |
          rm -rf test-agent-cli my-hybrid-agent
        working-directory: test-project

      - name: Test edge cases
        run: |
          echo "ðŸ” Testing edge cases..."

          echo "ðŸ§ª Test 1: Creating project in current directory"
          mkdir edge-case-test
          cd edge-case-test

          echo "ðŸ“ Creating project in current directory..."
          if ! node "$GITHUB_WORKSPACE/packages/cli/dist/cli.js" init .; then
            echo "âŒ Failed to create project in current directory"
            cd ..
            rm -rf edge-case-test
            exit 1
          fi

          if [ ! -f "package.json" ] || [ ! -f "src/agent.ts" ]; then
            echo "âŒ Required files not found when creating in current directory"
            ls -la
            cd ..
            rm -rf edge-case-test
            exit 1
          fi
          echo "âœ… Project created successfully in current directory"
          cd ..
          rm -rf edge-case-test

          echo "ðŸ§ª Test 2: Project name with special characters"
          echo "ðŸ“ Testing project creation with special characters..."
          if ! node "$GITHUB_WORKSPACE/packages/cli/dist/cli.js" init "My Amazing Agent!"; then
            echo "âŒ Failed to create project with special characters"
            exit 1
          fi

          if [ ! -d "my-amazing-agent" ]; then
            echo "âŒ Expected directory 'my-amazing-agent' not found"
            ls -la | grep "^d"
            exit 1
          fi
          echo "âœ… Directory created with sanitized name"

          echo "ðŸ” Checking package.json name field..."
          if ! grep -q '"name": "my-amazing-agent"' my-amazing-agent/package.json; then
            echo "âŒ Package.json name not sanitized correctly"
            echo "Current name:"
            node -e "console.log(JSON.parse(require('fs').readFileSync('my-amazing-agent/package.json', 'utf8')).name)"
            rm -rf my-amazing-agent
            exit 1
          fi
          echo "âœ… Package.json name correctly sanitized"
          rm -rf my-amazing-agent
        working-directory: test-project

  test-cli-installation:
    name: Test CLI Installation and Usage
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          run_install: false

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'pnpm'

      - name: Install dependencies and build
        run: |
          pnpm install --frozen-lockfile
          pnpm build

      - name: Create test environment
        run: |
          mkdir -p /tmp/cli-test
          cd /tmp/cli-test

      - name: Test CLI as npx command
        run: |
          echo "ðŸ” Testing CLI as npx command simulation..."
          cd /tmp/cli-test

          echo "ðŸ“¦ Setting up NODE_PATH for dependency resolution..."
          export NODE_PATH="/home/runner/work/hybrid/hybrid/packages/cli/node_modules:$NODE_PATH"
          echo "âœ… NODE_PATH configured"

          echo "ðŸš€ Running CLI init command for demo-project..."
          if ! node "$GITHUB_WORKSPACE/packages/cli/dist/cli.js" init demo-project; then
            echo "âŒ CLI init command failed"
            exit 1
          fi
          echo "âœ… CLI init command completed"

          echo "ðŸ” Verifying project creation..."
          if [ ! -d "demo-project" ]; then
            echo "âŒ demo-project directory not found"
            ls -la
            exit 1
          fi
          echo "âœ… demo-project directory created"

          if [ ! -f "demo-project/package.json" ]; then
            echo "âŒ demo-project/package.json not found"
            ls -la demo-project/
            exit 1
          fi
          echo "âœ… package.json exists"

          if [ ! -f "demo-project/src/agent.ts" ]; then
            echo "âŒ demo-project/src/agent.ts not found"
            ls -la demo-project/src/
            exit 1
          fi
          echo "âœ… src/agent.ts exists"

          echo "ðŸ“œ Checking npm scripts availability..."
          cd demo-project
          if npm run --help 2>/dev/null | grep -q "Available scripts"; then
            echo "âœ… npm scripts are available"
          else
            echo "â„¹ï¸ npm scripts check completed (may not show 'Available scripts')"
          fi
        working-directory: /tmp/cli-test

      - name: Test complete workflow
        run: |
          echo "ðŸ” Testing complete workflow..."

          echo "ðŸ”‘ Setting up environment for key generation..."
          export NODE_PATH="/home/runner/work/hybrid/hybrid/packages/cli/node_modules:$NODE_PATH"
          echo "âœ… NODE_PATH configured"

          echo "ðŸ” Testing key generation..."
          if ! node "$GITHUB_WORKSPACE/packages/cli/dist/cli.js" gen:keys --write; then
            echo "âŒ Key generation failed"
            exit 1
          fi
          echo "âœ… Key generation completed"

          echo "ðŸ” Verifying .env file creation..."
          if ! grep -q "XMTP_WALLET_KEY=0x" .env; then
            echo "âŒ XMTP_WALLET_KEY not found in .env"
            echo ".env contents:"
            cat .env
            exit 1
          fi
          echo "âœ… XMTP_WALLET_KEY found in .env"

          echo "ðŸ“œ Testing package.json scripts..."
          echo "ðŸ” Checking for required scripts..."
          node -e "
            const pkg = require('./package.json');
            const scripts = pkg.scripts;
            const required = ['dev', 'build', 'start', 'keys', 'test', 'lint', 'format'];
            const missing = [];
            const present = [];

            required.forEach(script => {
              if (scripts[script]) {
                present.push(script);
                console.log('âœ… Script present:', script, '->', scripts[script]);
              } else {
                missing.push(script);
                console.error('âŒ Missing script:', script);
              }
            });

            if (missing.length > 0) {
              console.error('Missing scripts:', missing.join(', '));
              process.exit(1);
            }

            console.log('ðŸŽ‰ All', present.length, 'required scripts are present');
          "

          echo "âœ… Complete workflow test passed"
        working-directory: /tmp/cli-test/demo-project

  test-cli-vitest:
    name: Test CLI with Vitest
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' || github.event_name == 'push'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          run_install: false

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build CLI
        run: pnpm build --filter=hybrid

      - name: Run CLI integration tests with Vitest
        run: |
          echo "ðŸ§ª Running CLI integration tests with Vitest..."
          cd packages/cli
          pnpm test
        env:
          NODE_ENV: test
          CI: true

      - name: Generate test coverage report
        run: |
          echo "ðŸ“Š Generating test coverage report..."
          cd packages/cli
          pnpm test:coverage

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: cli-test-results
          path: |
            packages/cli/coverage/
            packages/cli/test-temp/
          retention-days: 7

  test-cli-comprehensive:
    name: Comprehensive CLI Testing
    runs-on: ubuntu-latest
    needs: [test-cli, test-cli-installation, test-cli-vitest]
    if: always() && (needs.test-cli.result == 'success' || needs.test-cli-installation.result == 'success' || needs.test-cli-vitest.result == 'success')

    steps:
      - name: All CLI tests completed
        run: |
          echo "ðŸŽ‰ All CLI testing approaches have been executed"
          echo "ðŸ“Š Test Results Summary:"
          echo "  - Bash-based tests: ${{ needs.test-cli.result }}"
          echo "  - Installation tests: ${{ needs.test-cli-installation.result }}"
          echo "  - Vitest integration tests: ${{ needs.test-cli-vitest.result }}"
          echo ""
          echo "ðŸ’¡ For debugging failures:"
          echo "  - Check the verbose logs in each job for detailed error messages"
          echo "  - Use Vitest tests for the most detailed failure information"
          echo "  - Review uploaded artifacts for test coverage and temporary files"

